# linkspeed - docker-compose.yml

networks:
  linkspeed-network:

services:

  # ---- POSTGRES ----
  linkspeed-postgres:
    container_name: linkspeed-postgres
    platform: linux/amd64
    build: ./postgres
    image: linkspeed-postgres
    restart: unless-stopped
    networks:
      - linkspeed-network
    ports:
      - "45432:5432"
    volumes:
      - ./dbvolume:/bitnami/postgresql
    environment:
      - "POSTGRES_DB=linkspeeddb"
      - "POSTGRES_USER=linkspeed"
      - "POSTGRES_PASSWORD=linkspeed"

  # ---- PGADMIN ----
#  linkspeed-pgadmin:
#    container_name: linkspeed-pgadmin
#    build: ./pgadmin
#    image: linkspeed-pgadmin
#    depends_on:
#      - linkspeed-postgres
#    restart: unless-stopped
#    networks:
#      - linkspeed-network
#    ports:
#      - "45088:80"
#    environment:
#      - "PGADMIN_DEFAULT_EMAIL=pgadmin@pgadmin.com"
#      - "PGADMIN_DEFAULT_PASSWORD=pgadmin"

  # ---- FASTAPI ----
  linkspeed-fastapi:
    container_name: linkspeed-fastapi
    build: ./fastapi
    image: linkspeed-fastapi
    depends_on:
      - linkspeed-postgres
    restart: unless-stopped
    networks:
      - linkspeed-network
    ports:
      - "48000:8000"
    environment:
      - "STACK_ENV=DEVELOPMENT"
      - "FASTAPI_LOG_LEVEL=DEBUG"
      - "POSTGRES_DB=linkspeeddb"
      - "POSTGRES_USER=linkspeed"
      - "POSTGRES_PASSWORD=linkspeed"
#    command: [
#      "gunicorn",
#      "-w",
#      "4",
#      "-k",
#      "uvicorn.workers.UvicornWorker",
#      "main:app",
#      "--bind",
#      "0.0.0.0:8000",
#    ]
###############
#    command: [
#      "/appdir/wait-for-it.sh",
#      "--host=linkspeed-postgres",
#      "--port=5432",
#      "--timeout=20",
#      "--",
#      "gunicorn",
#      "-w",
#      "4",
#      "-k",
#      "uvicorn.workers.UvicornWorker",
#      "main:app",
#      "--bind",
#      "0.0.0.0:8000",
#    ]

  # ---- NOTEBOOK ----    [DEV]
  linkspeed-notebook:
    container_name: linkspeed-notebook
    build: ./notebook
    image: linkspeed-notebook
    depends_on:
      - linkspeed-postgres
      - linkspeed-fastapi
    restart: unless-stopped
    networks:
      - linkspeed-network
    ports:
      - "48888:8888"
    volumes:
      - ./notebook:/home/bedrock/workspace
    environment:
      - "JUPYTERLAB_SETTINGS_DIR=/home/linkspeed/workspace"
      - "MAPBOX_TOKEN=pk.eyJ1Ijoic21hcnRtZXRhbCIsImEiOiJjbWJnbnRhbHIwMHN5MmpvaDN5M2E3dnptIn0.OOMN3laXveAb-ep2U2WqsQ"
      # TODO: Clarify/comment BASE_URL. Needs a much better name.
      - "BASE_URL=http://linkspeed-fastapi:8000"
    command: [
      "start-notebook.sh",
      "--NotebookApp.token=''",
      "--NotebookApp.password=''",
      "--ServerApp.iopub_data_rate_limit=10000000",
      "--ServerApp.rate_limit_window=10.0",
    ]

